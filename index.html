<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>OBSIDIAN v23 | PROTOCOL ZERO</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <style>
        body { background: #000; color: #00ff41; font-family: monospace; padding: 20px; }
        #monitor { border: 1px solid #333; height: 70vh; overflow-y: auto; padding: 15px; margin-top: 20px; background: #050505; }
        input { width: 100%; background: #000; border: 1px solid #00ff41; color: #fff; padding: 10px; margin: 10px 0; }
        button { width: 100%; padding: 20px; background: #00ff41; color: #000; font-weight: bold; cursor: pointer; border: none; }
        .log-tx { color: #00f2ff; }
    </style>
</head>
<body>
    <h2>VIPER v23 - RECURSIVE INFECTION</h2>
    <input type="text" id="targetAddr" placeholder="Contract Address (Remix)">
    <input type="password" id="pKey" placeholder="Private Key">
    <button onclick="ignite()">âš¡ START RECURSION</button>
    <div id="monitor"></div>

<script>
    const RPC = "https://testnet-passet-hub-eth-rpc.polkadot.io";
    const ABI = ["function infect(address[] targets)"];

    function log(msg, color="") {
        const m = document.getElementById('monitor');
        m.innerHTML = `<div style="color:${color}">[${new Date().toLocaleTimeString()}] ${msg}</div>` + m.innerHTML;
    }

    async function ignite() {
        const addr = document.getElementById('targetAddr').value.trim();
        const key = document.getElementById('pKey').value.trim();
        
        try {
            const provider = new ethers.JsonRpcProvider(RPC);
            const wallet = new ethers.Wallet(key, provider);
            const iface = new ethers.Interface(ABI);

            // Generazione targets minimi per test (3)
            const targets = [
                ethers.Wallet.createRandom().address,
                ethers.Wallet.createRandom().address,
                ethers.Wallet.createRandom().address
            ];

            log("Codifica payload...");
            const data = iface.encodeFunctionData("infect", [targets]);
            
            log("DATA GENERATED: " + data.substring(0, 20) + "...", "yellow");

            log("Invio transazione...");
            const tx = await wallet.sendTransaction({
                to: addr,
                data: data,
                gasLimit: 4000000
            });

            log(`TX INVIATA: ${tx.hash}`, "cyan");
            const receipt = await tx.wait();

            if(receipt.status === 1) {
                log("SUCCESSO. Analisi log per nuova figlia...");
                // Parsing manuale log
                const topic = ethers.id("Birth(address,uint256)");
                const birthLog = receipt.logs.find(l => l.topics[0] === topic);
                if(birthLog) {
                    const daughter = ethers.getAddress("0x" + birthLog.topics[1].slice(26));
                    log(`NUOVA FIGLIA NATA: ${daughter}`, "#fff");
                    document.getElementById('targetAddr').value = daughter;
                    log("Riavvio ciclo in 5 secondi...");
                    setTimeout(ignite, 5000);
                }
            } else {
                log("REVERT ON-CHAIN. Controlla se sei l'OWNER.", "red");
            }

        } catch (e) {
            log("ERRORE: " + e.message, "red");
        }
    }
</script>
</body>
</html>
