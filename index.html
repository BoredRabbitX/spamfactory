<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>OBSIDIAN v10 | MATRIOSKA EDITION</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <style>
        :root { --matrioska: #ff00ff; --cyan: #00f2ff; --bg: #050505; --panel: #111; }
        body { background: var(--bg); color: #fff; font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; height: 100vh; }
        .sidebar { width: 400px; background: var(--panel); border-right: 1px solid var(--matrioska); padding: 20px; display: flex; flex-direction: column; }
        #console { flex-grow: 1; background: #000; padding: 20px; font-family: monospace; overflow-y: auto; color: var(--cyan); }
        .btn-matrioska { background: var(--matrioska); color: #000; padding: 20px; font-weight: 900; border: none; cursor: pointer; text-transform: uppercase; box-shadow: 0 0 15px var(--matrioska); }
        input, textarea { background: #000; border: 1px solid #333; color: var(--cyan); padding: 10px; width: 100%; box-sizing: border-box; margin-bottom: 10px; }
        .stat { font-size: 12px; color: #888; margin-bottom: 5px; }
        .log-new-addr { color: #fff; background: #550055; padding: 2px 5px; }
    </style>
</head>
<body>

<div class="sidebar">
    <h1 style="color:var(--matrioska)">MATRIOSKA v10</h1>
    <div class="stat">Current Factory Address:</div>
    <input type="text" id="currentAddr" placeholder="Indirizzo Matrioska Attiva">
    
    <div class="stat">Owner Private Key:</div>
    <input type="password" id="pKey" placeholder="0x...">

    <div class="stat">Automazione:</div>
    <button class="btn-matrioska" id="actionBtn" onclick="toggleMatrioska()">Start Replicating Chain</button>
    
    <div style="margin-top:20px" class="stat">Targets rilevati:</div>
    <textarea id="tDisplay" readonly></textarea>
</div>

<div id="console">
    <div>[SYSTEM] In attesa di inizializzazione catena Matrioska...</div>
</div>

<script>
    const ABI = [
        "function blast(address[] memory targets, uint256 amount) external",
        "event MatrioskaBirthed(address indexed daughter)"
    ];
    const RPC = "https://testnet-passet-hub-eth-rpc.polkadot.io";
    let active = false;

    function log(msg, cls="") {
        const c = document.getElementById('console');
        c.innerHTML = `<div class="${cls}">[${new Date().toLocaleTimeString()}] ${msg}</div>` + c.innerHTML;
    }

    async function toggleMatrioska() {
        if(active) { active = false; return; }
        active = true;
        runChain();
    }

    async function runChain() {
        if(!active) return;
        const key = document.getElementById('pKey').value;
        const factoryAddr = document.getElementById('currentAddr').value;
        
        try {
            const provider = new ethers.JsonRpcProvider(RPC);
            const wallet = new ethers.Wallet(key, provider);
            const contract = new ethers.Contract(factoryAddr, ABI, wallet);

            // 1. Scrape targets
            let targets = [];
            for(let i=0; i<15; i++) targets.push(ethers.Wallet.createRandom().address);
            document.getElementById('tDisplay').value = targets.join("\n");

            log("Lancio Blast + Clonazione Matrioska...");
            const tx = await contract.blast(targets, 1000000, { gasLimit: 3000000 });
            log(`TX: ${tx.hash}`);
            
            const receipt = await tx.wait();
            
            // 2. Trova la nuova figlia nei log
            const event = receipt.logs.find(l => l.topics[0] === ethers.id("MatrioskaBirthed(address)"));
            const daughterAddr = ethers.getAddress("0x" + event.topics[1].slice(26));
            
            log(`NUOVA MATRIOSKA NATA: ${daughterAddr}`, "log-new-addr");
            
            // 3. Aggiorna l'indirizzo per il prossimo giro
            document.getElementById('currentAddr').value = daughterAddr;

            log("Attesa 60s per il prossimo livello della catena...");
            setTimeout(runChain, 60000);

        } catch (e) {
            log("ERRORE CATENA: " + e.message, "error");
            active = false;
        }
    }
</script>
</body>
</html>
